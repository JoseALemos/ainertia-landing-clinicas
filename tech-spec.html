<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Especificaci√≥n T√©cnica ‚Äî Automatizaci√≥n WhatsApp para Cl√≠nicas Dentales | Ainertia Capital</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --blue: #1a6fb5; --blue-light: #e8f3fc; --teal: #0fa98e;
      --dark: #1a2332; --text: #2c3e50; --muted: #6b7c93;
      --border: #e2e8f0; --bg: #f8fafc; --code-bg: #1e2d3d;
    }
    body { font-family: 'Segoe UI', system-ui, sans-serif; color: var(--text); background: #fff; font-size: 14px; line-height: 1.65; max-width: 860px; margin: 0 auto; }

    /* COVER */
    .cover { background: linear-gradient(160deg, #1a2332 0%, #1e3a5f 100%); color: #fff; padding: 60px; page-break-after: always; }
    .cover-logo { font-size: 1.2rem; font-weight: 800; margin-bottom: 50px; }
    .cover-logo span { color: var(--teal); }
    .cover-tag { display: inline-block; background: rgba(15,169,142,.2); border: 1px solid rgba(15,169,142,.4); color: var(--teal); border-radius: 100px; padding: .25rem .875rem; font-size: .7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1.25rem; }
    .cover h1 { font-size: 2rem; font-weight: 900; line-height: 1.2; margin-bottom: 1rem; }
    .cover h1 em { color: var(--teal); font-style: normal; }
    .cover-sub { color: rgba(255,255,255,.6); font-size: .95rem; max-width: 500px; margin-bottom: 50px; }
    .cover-meta { display: flex; gap: 2rem; flex-wrap: wrap; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,.12); }
    .cover-meta-item { font-size: .72rem; color: rgba(255,255,255,.5); }
    .cover-meta-item strong { display: block; font-size: .82rem; color: rgba(255,255,255,.85); font-weight: 600; margin-bottom: .1rem; }

    /* LAYOUT */
    .page { padding: 40px 60px; }
    .page + .page { border-top: 2px solid var(--border); }
    .section-label { font-size: .65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: var(--teal); margin-bottom: .4rem; }
    h2 { font-size: 1.4rem; font-weight: 800; color: var(--dark); line-height: 1.2; margin-bottom: .75rem; }
    h3 { font-size: 1rem; font-weight: 700; color: var(--dark); margin-bottom: .4rem; margin-top: 1.25rem; }
    h4 { font-size: .875rem; font-weight: 700; color: var(--blue); margin-bottom: .3rem; margin-top: 1rem; }
    p { margin-bottom: .75rem; }
    p:last-child { margin-bottom: 0; }
    ul, ol { padding-left: 1.25rem; margin-bottom: .75rem; }
    li { margin-bottom: .3rem; font-size: .875rem; }

    /* CODE */
    pre {
      background: var(--code-bg); color: #e2e8f0; border-radius: 10px;
      padding: 1.25rem 1.5rem; font-family: 'Courier New', monospace;
      font-size: .8rem; line-height: 1.7; overflow-x: auto;
      margin: .875rem 0; white-space: pre;
    }
    code { background: #f1f5f9; color: var(--blue); padding: .1rem .35rem; border-radius: 4px; font-size: .82rem; font-family: 'Courier New', monospace; }

    /* CARDS */
    .card { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; }
    .card h3 { margin-top: 0; }

    /* GRID */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin: 1rem 0; }

    /* STACK */
    .stack-item { display: flex; gap: .875rem; align-items: flex-start; padding: .875rem 1rem; border: 1px solid var(--border); border-radius: 10px; margin-bottom: .625rem; }
    .stack-badge { background: var(--blue); color: #fff; border-radius: 8px; padding: .3rem .7rem; font-size: .7rem; font-weight: 700; white-space: nowrap; flex-shrink: 0; }
    .stack-badge.alt { background: var(--teal); }
    .stack-badge.warn { background: #f59e0b; }
    .stack-item p { font-size: .82rem; color: var(--muted); margin: .2rem 0 0; }

    /* FLOW */
    .flow { background: var(--code-bg); color: #e2e8f0; border-radius: 12px; padding: 1.5rem; font-family: 'Courier New', monospace; font-size: .8rem; line-height: 2; margin: 1rem 0; }
    .flow .step { color: #93c5fd; }
    .flow .action { color: #6ee7b7; }
    .flow .cond { color: #fde68a; }
    .flow .arrow { color: #64748b; }

    /* TABLE */
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: .82rem; }
    th { background: var(--bg); text-align: left; padding: .625rem .875rem; border-bottom: 2px solid var(--border); font-size: .72rem; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); }
    td { padding: .625rem .875rem; border-bottom: 1px solid var(--border); vertical-align: top; }
    tr:last-child td { border-bottom: none; }

    /* BADGE */
    .badge { display: inline-block; border-radius: 100px; padding: .15rem .6rem; font-size: .68rem; font-weight: 600; }
    .badge-blue { background: var(--blue-light); color: var(--blue); }
    .badge-green { background: #dcfce7; color: #16a34a; }
    .badge-yellow { background: #fef9c3; color: #a16207; }
    .badge-red { background: #fee2e2; color: #dc2626; }

    /* ALERT */
    .alert { border-radius: 10px; padding: .875rem 1rem; margin: .875rem 0; font-size: .82rem; display: flex; gap: .625rem; }
    .alert-info { background: var(--blue-light); border: 1px solid #bfdbfe; color: #1e40af; }
    .alert-warn { background: #fef9c3; border: 1px solid #fde68a; color: #92400e; }
    .alert-critical { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; }

    /* FOOTER */
    .doc-footer { padding: 1.25rem 60px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; font-size: .7rem; color: var(--muted); }

    @media print {
      body { max-width: 100%; }
      .cover { page-break-after: always; }
      .page { page-break-inside: avoid; }
      @page { margin: 0; size: A4; }
    }
  </style>
</head>
<body>

<!-- COVER -->
<div class="cover">
  <div class="cover-logo">Ainertia<span>.</span></div>
  <div class="cover-tag">Especificaci√≥n T√©cnica v1.0</div>
  <h1>Sistema de <em>automatizaci√≥n WhatsApp</em><br/>para cl√≠nicas dentales</h1>
  <p class="cover-sub">Arquitectura, flujos, stack tecnol√≥gico e integraciones para el equipo de desarrollo.</p>
  <div class="cover-meta">
    <div class="cover-meta-item"><strong>Proyecto</strong>Ainertia Dental Automation</div>
    <div class="cover-meta-item"><strong>Versi√≥n</strong>1.0 ‚Äî MVP</div>
    <div class="cover-meta-item"><strong>Audiencia</strong>Equipo IT / Desarrollo</div>
    <div class="cover-meta-item"><strong>Fecha</strong>Febrero 2026</div>
    <div class="cover-meta-item"><strong>Contacto t√©cnico</strong>tech@ainertia.ai</div>
  </div>
</div>

<!-- 1. RESUMEN EJECUTIVO -->
<div class="page">
  <div class="section-label">Secci√≥n 1</div>
  <h2>Resumen del sistema</h2>
  <p>El sistema automatiza la comunicaci√≥n entre cl√≠nicas dentales y sus pacientes a trav√©s de WhatsApp Business API. Gestiona el ciclo completo: recordatorio de cita ‚Üí confirmaci√≥n ‚Üí cancelaci√≥n/reagendado ‚Üí solicitud de rese√±a ‚Üí FAQ autom√°tico.</p>
  <p>El sistema es <strong>multi-tenant</strong>: una √∫nica instancia sirve a m√∫ltiples cl√≠nicas. Cada cl√≠nica tiene su propio n√∫mero de WhatsApp, su configuraci√≥n de mensajes y su acceso al panel de control.</p>

  <div class="alert alert-info">
    ‚ÑπÔ∏è <span>Este documento describe el MVP. Las funcionalidades marcadas como <strong>v2</strong> son para fases posteriores.</span>
  </div>

  <h3>Funcionalidades del MVP</h3>
  <div class="grid-2">
    <div class="card">
      <h4>‚úÖ Incluido en MVP</h4>
      <ul>
        <li>Recordatorio 24h antes de la cita</li>
        <li>Confirmaci√≥n de asistencia (S√≠/No)</li>
        <li>Gesti√≥n de cancelaciones</li>
        <li>Solicitud de rese√±a Google post-visita</li>
        <li>Respuesta a FAQ predefinidas</li>
        <li>Panel de control por cl√≠nica</li>
        <li>API de integraci√≥n con agenda</li>
      </ul>
    </div>
    <div class="card">
      <h4>üîú Fase 2 (v2)</h4>
      <ul>
        <li>Reagendado autom√°tico de huecos</li>
        <li>Campa√±as de reactivaci√≥n de pacientes</li>
        <li>Integraci√≥n nativa con Gesden/RCDent</li>
        <li>App m√≥vil para la cl√≠nica</li>
        <li>Informes autom√°ticos mensuales</li>
        <li>NPS y encuestas de satisfacci√≥n</li>
      </ul>
    </div>
  </div>
</div>

<!-- 2. ARQUITECTURA -->
<div class="page">
  <div class="section-label">Secci√≥n 2</div>
  <h2>Arquitectura del sistema</h2>

  <div class="flow">
<span class="step">[AGENDA CL√çNICA]</span>        <span class="arrow">‚îÄ‚îÄ‚îÄ‚îÄ CSV / API ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫</span>  <span class="action">[AINERTIA CORE]</span>
  Gesden / Excel / Google Sheets                       Node.js + PostgreSQL
                                                              ‚îÇ
              <span class="arrow">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§</span>
              ‚îÇ                                          ‚îÇ
  <span class="step">[WHATSAPP API]</span>                              <span class="step">[PANEL ADMIN]</span>
  360dialog / Twilio                                  React / Next.js
  WhatsApp Business                                   Una URL por cl√≠nica
              ‚îÇ
  <span class="step">[PACIENTE]</span>
  Responde S√≠ / No / Cambiar
              ‚îÇ
  <span class="cond">[MOTOR DE DECISI√ìN]</span>
  n8n / l√≥gica propia
  ‚îú‚îÄ‚îÄ Confirmar ‚Üí marcar en agenda
  ‚îú‚îÄ‚îÄ Cancelar ‚Üí avisar recepci√≥n
  ‚îî‚îÄ‚îÄ FAQ ‚Üí respuesta autom√°tica
  </div>

  <h3>Componentes principales</h3>
  <table>
    <thead><tr><th>Componente</th><th>Responsabilidad</th><th>Tecnolog√≠a</th></tr></thead>
    <tbody>
      <tr><td><strong>Core API</strong></td><td>L√≥gica de negocio, gesti√≥n multi-tenant, scheduling</td><td>Node.js / Express</td></tr>
      <tr><td><strong>Message Engine</strong></td><td>Env√≠o y recepci√≥n de mensajes WhatsApp</td><td>360dialog API + Webhooks</td></tr>
      <tr><td><strong>Scheduler</strong></td><td>Cron jobs para recordatorios seg√∫n agenda</td><td>node-cron / Bull Queue</td></tr>
      <tr><td><strong>Conversation State</strong></td><td>Estado de cada conversaci√≥n activa</td><td>Redis / PostgreSQL</td></tr>
      <tr><td><strong>Integration Layer</strong></td><td>Lectura de agenda de la cl√≠nica</td><td>CSV parser / REST adapter</td></tr>
      <tr><td><strong>Panel de Control</strong></td><td>Dashboard por cl√≠nica (confirmaciones, m√©tricas)</td><td>React + API REST</td></tr>
      <tr><td><strong>Base de Datos</strong></td><td>Persistencia principal</td><td>PostgreSQL</td></tr>
    </tbody>
  </table>
</div>

<!-- 3. STACK TECNOL√ìGICO -->
<div class="page">
  <div class="section-label">Secci√≥n 3</div>
  <h2>Stack tecnol√≥gico</h2>

  <h3>Obligatorio</h3>
  <div class="stack-item">
    <span class="stack-badge">WhatsApp API</span>
    <div><strong>360dialog</strong> (recomendado) o Twilio WhatsApp
    <p>Proveedor oficial de WhatsApp Business API. 360dialog es m√°s barato (~15‚Ç¨/mes/n√∫mero) y tiene mejor soporte en Europa. Requiere aprobaci√≥n de Meta por n√∫mero (24-48h). Una cuenta de partner permite gestionar m√∫ltiples clientes.</p></div>
  </div>
  <div class="stack-item">
    <span class="stack-badge">Backend</span>
    <div><strong>Node.js + Express</strong>
    <p>API REST principal. Gestiona webhooks de WhatsApp, l√≥gica multi-tenant, scheduling de mensajes y conexi√≥n a DB.</p></div>
  </div>
  <div class="stack-item">
    <span class="stack-badge">Base de datos</span>
    <div><strong>PostgreSQL</strong>
    <p>Cl√≠nicas, pacientes, citas, estado de conversaciones, logs de mensajes, configuraci√≥n por tenant.</p></div>
  </div>
  <div class="stack-item">
    <span class="stack-badge alt">Queue</span>
    <div><strong>Bull + Redis</strong>
    <p>Cola de mensajes para gestionar el scheduling de recordatorios sin bloquear el proceso principal. Imprescindible para escalar a m√∫ltiples cl√≠nicas.</p></div>
  </div>
  <div class="stack-item">
    <span class="stack-badge alt">Automatizaci√≥n</span>
    <div><strong>n8n</strong> (opcional para MVP) o l√≥gica propia en Node.js
    <p>Si se usa n8n, los flujos se crean visualmente y son m√°s f√°ciles de mantener. Recomendado para el MVP para reducir tiempo de desarrollo. En producci√≥n se puede migrar a c√≥digo propio.</p></div>
  </div>
  <div class="stack-item">
    <span class="stack-badge warn">Hosting</span>
    <div><strong>Railway</strong> (ya disponible en Ainertia)
    <p>Soporta Node.js, PostgreSQL y Redis. Despliegue desde GitHub con auto-deploy. Suficiente para MVP y primeros 50 clientes.</p></div>
  </div>

  <h3>Variables de entorno requeridas</h3>
  <pre>
# WhatsApp
WABA_API_KEY=360dialog_api_key
WABA_WEBHOOK_SECRET=webhook_verify_token

# Base de datos
DATABASE_URL=postgresql://user:pass@host:5432/dental_automation

# Redis
REDIS_URL=redis://localhost:6379

# App
NODE_ENV=production
PORT=3000
JWT_SECRET=secret_muy_largo
ADMIN_SECRET=clave_panel_admin

# Opcionales
SMTP_HOST=smtp.gmail.com
SMTP_USER=notificaciones@ainertia.ai
SMTP_PASS=app_password
  </pre>
</div>

<!-- 4. SCHEMA DE BASE DE DATOS -->
<div class="page">
  <div class="section-label">Secci√≥n 4</div>
  <h2>Schema de base de datos</h2>

  <pre>
-- Multi-tenant: cada cl√≠nica es un tenant
CREATE TABLE clinicas (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nombre          VARCHAR(200) NOT NULL,
  telefono_wa     VARCHAR(20) UNIQUE NOT NULL,  -- n√∫mero WhatsApp de la cl√≠nica
  wa_api_key      TEXT,                          -- API key 360dialog de este n√∫mero
  plan            VARCHAR(20) DEFAULT 'profesional', -- basico | profesional | avanzado
  activo          BOOLEAN DEFAULT true,
  config          JSONB DEFAULT '{}',            -- mensajes personalizados, horarios...
  created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- Pacientes (por cl√≠nica)
CREATE TABLE pacientes (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinica_id      UUID REFERENCES clinicas(id) ON DELETE CASCADE,
  nombre          VARCHAR(100) NOT NULL,
  telefono        VARCHAR(20) NOT NULL,
  telefono_norm   VARCHAR(20),                   -- E.164: +34612345678
  email           VARCHAR(200),
  activo          BOOLEAN DEFAULT true,
  created_at      TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(clinica_id, telefono_norm)
);

-- Citas (importadas desde la agenda de la cl√≠nica)
CREATE TABLE citas (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinica_id      UUID REFERENCES clinicas(id) ON DELETE CASCADE,
  paciente_id     UUID REFERENCES pacientes(id),
  fecha_hora      TIMESTAMPTZ NOT NULL,
  duracion_min    INTEGER DEFAULT 45,
  tipo            VARCHAR(100),                  -- limpieza, empaste, revisi√≥n...
  dentista        VARCHAR(100),
  estado          VARCHAR(20) DEFAULT 'pendiente', -- pendiente | confirmada | cancelada | completada
  ext_id          VARCHAR(100),                  -- ID en el sistema de la cl√≠nica
  recordatorio_enviado BOOLEAN DEFAULT false,
  resena_solicitada    BOOLEAN DEFAULT false,
  created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- Conversaciones activas por paciente
CREATE TABLE conversaciones (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinica_id      UUID REFERENCES clinicas(id),
  paciente_id     UUID REFERENCES pacientes(id),
  telefono        VARCHAR(20) NOT NULL,
  estado          VARCHAR(30) DEFAULT 'idle',    -- idle | esperando_confirmacion | en_cancelacion | faq
  contexto        JSONB DEFAULT '{}',            -- cita_id, paso actual del flujo...
  ultimo_mensaje  TIMESTAMPTZ,
  created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- Log de mensajes (auditor√≠a)
CREATE TABLE mensajes_log (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinica_id      UUID REFERENCES clinicas(id),
  paciente_id     UUID REFERENCES pacientes(id),
  direccion       VARCHAR(10) NOT NULL,          -- entrante | saliente
  contenido       TEXT,
  tipo            VARCHAR(30),                   -- recordatorio | confirmacion | cancelacion | resena | faq
  wa_message_id   VARCHAR(100),
  created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- √çndices clave
CREATE INDEX idx_citas_clinica_fecha ON citas(clinica_id, fecha_hora);
CREATE INDEX idx_citas_recordatorio  ON citas(recordatorio_enviado, fecha_hora) WHERE estado = 'pendiente';
CREATE INDEX idx_pacientes_telefono  ON pacientes(clinica_id, telefono_norm);
  </pre>
</div>

<!-- 5. FLUJOS DE AUTOMATIZACI√ìN -->
<div class="page">
  <div class="section-label">Secci√≥n 5</div>
  <h2>Flujos de automatizaci√≥n</h2>

  <h3>Flujo 1 ‚Äî Recordatorio y confirmaci√≥n de cita</h3>
  <div class="flow">
<span class="step">TRIGGER:</span> Cron cada 5 minutos
  ‚îî‚îÄ‚îÄ SELECT citas WHERE fecha_hora BETWEEN NOW()+23h AND NOW()+25h
      AND recordatorio_enviado = false AND estado = 'pendiente'

<span class="action">PASO 1:</span> Enviar mensaje WhatsApp al paciente
  Mensaje: "Hola {nombre} üëã Te recordamos tu cita de ma√±ana
  {dia} a las {hora} con {dentista}. ¬øConfirmas asistencia?"
  + Botones interactivos: [‚úÖ Confirmar] [‚ùå Cancelar] [üìÖ Cambiar]

<span class="action">PASO 2:</span> Marcar recordatorio_enviado = true
  Crear conversaci√≥n estado = 'esperando_confirmacion' con cita_id

<span class="cond">RESPUESTA DEL PACIENTE:</span>
  ‚îú‚îÄ‚îÄ "Confirmar" ‚Üí cita.estado = 'confirmada' ‚Üí mensaje: "¬°Perfecto! Te esperamos üòä"
  ‚îú‚îÄ‚îÄ "Cancelar"  ‚Üí cita.estado = 'cancelada'  ‚Üí notificar recepci√≥n ‚Üí Flujo 2
  ‚îú‚îÄ‚îÄ "Cambiar"   ‚Üí conversacion.estado = 'en_cancelacion' ‚Üí Flujo 3
  ‚îî‚îÄ‚îÄ Sin respuesta en 4h ‚Üí segundo recordatorio (solo 1 reintento)
  </div>

  <h3>Flujo 2 ‚Äî Notificaci√≥n de cancelaci√≥n a la cl√≠nica</h3>
  <div class="flow">
<span class="step">TRIGGER:</span> Paciente cancela (bot√≥n o mensaje)

<span class="action">PASO 1:</span> cita.estado = 'cancelada'
<span class="action">PASO 2:</span> Enviar WhatsApp a recepci√≥n de la cl√≠nica:
  "‚ö†Ô∏è {paciente} ha cancelado su cita del {dia} a las {hora}"
<span class="action">PASO 3:</span> Mensaje al paciente: "Entendido. Hemos liberado tu cita.
  Si quieres volver a pedir hora, escr√≠benos aqu√≠ üìÖ"
  </div>

  <h3>Flujo 3 ‚Äî Solicitud de rese√±a post-visita</h3>
  <div class="flow">
<span class="step">TRIGGER:</span> Cron cada hora
  ‚îî‚îÄ‚îÄ SELECT citas WHERE estado = 'completada'
      AND fecha_hora BETWEEN NOW()-4h AND NOW()-2h
      AND resena_solicitada = false

<span class="action">PASO 1:</span> Enviar mensaje al paciente:
  "{nombre}, esperamos que hayas quedado satisfecho/a con tu visita üòä
  Si tienes un momento, nos ayudar√≠a mucho que dejaras una rese√±a en Google:"
  + Link directo al perfil Google Maps de la cl√≠nica

<span class="action">PASO 2:</span> resena_solicitada = true
  </div>

  <h3>Flujo 4 ‚Äî FAQ autom√°tico</h3>
  <div class="flow">
<span class="step">TRIGGER:</span> Webhook ‚Äî mensaje entrante de paciente no clasificado

<span class="cond">DETECCI√ìN DE INTENCI√ìN</span> (keywords o IA):
  ‚îú‚îÄ‚îÄ "horario" / "hora" / "cu√°ndo abren"
  ‚îÇ     ‚Üí "Nuestro horario es {horario de config}"
  ‚îú‚îÄ‚îÄ "direcci√≥n" / "d√≥nde est√°n" / "c√≥mo llegar"
  ‚îÇ     ‚Üí "Estamos en {direcci√≥n}. Google Maps: {link}"
  ‚îú‚îÄ‚îÄ "precio" / "cu√°nto cuesta" / "presupuesto"
  ‚îÇ     ‚Üí "Para presupuestos personalizados, ll√°manos al {telefono}
  ‚îÇ        o vis√≠tanos. La primera revisi√≥n es gratuita."
  ‚îú‚îÄ‚îÄ "cita" / "pedir hora" / "quiero una cita"
  ‚îÇ     ‚Üí "Para pedir cita ll√°manos al {telefono} o escr√≠benos tu
  ‚îÇ        disponibilidad y te confirmamos hueco."
  ‚îî‚îÄ‚îÄ Sin match ‚Üí "Hola üëã Para atenderte mejor, contacta con
        nosotros en {telefono} o p√°sate por la cl√≠nica."
  </div>
</div>

<!-- 6. API DE INTEGRACI√ìN CON LA AGENDA -->
<div class="page">
  <div class="section-label">Secci√≥n 6</div>
  <h2>Integraci√≥n con la agenda de la cl√≠nica</h2>

  <div class="alert alert-warn">
    ‚ö†Ô∏è <span>Este es el punto m√°s variable del proyecto. Los softwares de gesti√≥n dental en Espa√±a (Gesden, RCDent, Oris, Dentsply) no tienen API p√∫blica. Se ofrecen tres m√©todos de integraci√≥n por orden de preferencia.</span>
  </div>

  <h3>M√©todo A ‚Äî Importaci√≥n CSV/Excel (MVP recomendado)</h3>
  <p>La cl√≠nica exporta su agenda diaria desde su software en CSV o Excel y la sube al panel de Ainertia o a una carpeta compartida (Google Drive / Dropbox).</p>
  <pre>
# Formato CSV esperado (negociable con cada cl√≠nica)
fecha_hora,paciente_nombre,paciente_telefono,dentista,tipo_cita,duracion_min
2026-03-15 10:30,Ana Garc√≠a,+34612345678,Dr. Fern√°ndez,Limpieza,45
2026-03-15 11:30,Luis Mart√≠n,+34698765432,Dr. Fern√°ndez,Revisi√≥n,30

# Endpoint de importaci√≥n
POST /api/v1/clinicas/:clinica_id/agenda/import
Content-Type: multipart/form-data
Authorization: Bearer {api_key}
Body: { file: agenda.csv }
  </pre>

  <h3>M√©todo B ‚Äî Webhook push desde la cl√≠nica (ideal)</h3>
  <p>El software de la cl√≠nica (o un script intermedio) notifica a Ainertia cada vez que se crea, modifica o cancela una cita.</p>
  <pre>
# Ainertia expone este endpoint
POST /api/v1/webhooks/cita
Authorization: Bearer {api_key}
{
  "evento": "cita_creada",         // cita_creada | cita_cancelada | cita_completada
  "ext_id": "GES-20260315-001",    // ID en el sistema origen
  "paciente": {
    "nombre": "Ana Garc√≠a",
    "telefono": "+34612345678"
  },
  "cita": {
    "fecha_hora": "2026-03-15T10:30:00+01:00",
    "duracion_min": 45,
    "tipo": "Limpieza",
    "dentista": "Dr. Fern√°ndez"
  }
}

# Respuesta
{ "ok": true, "cita_id": "uuid-generado" }
  </pre>

  <h3>M√©todo C ‚Äî Acceso directo a BD del software (avanzado)</h3>
  <p>Con permiso y acceso t√©cnico al servidor de la cl√≠nica, un script lee peri√≥dicamente la base de datos del software de gesti√≥n y sincroniza con Ainertia.</p>
  <div class="alert alert-critical">
    üî¥ <span>Requiere acuerdo firmado con la cl√≠nica y con el proveedor del software. Solo recomendado para clientes enterprise con plan Avanzado.</span>
  </div>
</div>

<!-- 7. API INTERNA -->
<div class="page">
  <div class="section-label">Secci√≥n 7</div>
  <h2>Endpoints de la API interna</h2>

  <table>
    <thead><tr><th>M√©todo</th><th>Endpoint</th><th>Descripci√≥n</th><th>Auth</th></tr></thead>
    <tbody>
      <tr><td><span class="badge badge-green">POST</span></td><td><code>/api/v1/auth/login</code></td><td>Login de administrador de cl√≠nica</td><td>‚Äî</td></tr>
      <tr><td><span class="badge badge-blue">GET</span></td><td><code>/api/v1/clinicas/:id/stats</code></td><td>Estad√≠sticas: confirmaciones, ausencias, rese√±as</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-blue">GET</span></td><td><code>/api/v1/clinicas/:id/citas</code></td><td>Listado de citas (filtros: fecha, estado)</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-green">POST</span></td><td><code>/api/v1/webhooks/cita</code></td><td>Recibir nueva cita desde agenda externa</td><td>API Key</td></tr>
      <tr><td><span class="badge badge-green">POST</span></td><td><code>/api/v1/clinicas/:id/agenda/import</code></td><td>Importar CSV de agenda</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-blue">GET</span></td><td><code>/api/v1/clinicas/:id/mensajes</code></td><td>Log de mensajes enviados/recibidos</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-yellow">PATCH</span></td><td><code>/api/v1/clinicas/:id/config</code></td><td>Actualizar configuraci√≥n (mensajes, horarios)</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-green">POST</span></td><td><code>/api/v1/whatsapp/webhook</code></td><td>Webhook de 360dialog (mensajes entrantes)</td><td>HMAC</td></tr>
      <tr><td><span class="badge badge-blue">GET</span></td><td><code>/api/v1/admin/clinicas</code></td><td>Listado de todos los clientes (superadmin)</td><td>Admin Key</td></tr>
    </tbody>
  </table>

  <h3>Estructura de respuesta est√°ndar</h3>
  <pre>
// √âxito
{ "ok": true, "data": { ... } }

// Error
{ "ok": false, "error": "Mensaje de error", "code": "ERROR_CODE" }
  </pre>
</div>

<!-- 8. SEGURIDAD Y RGPD -->
<div class="page">
  <div class="section-label">Secci√≥n 8</div>
  <h2>Seguridad y cumplimiento RGPD</h2>

  <div class="grid-2">
    <div class="card">
      <h3>Medidas t√©cnicas</h3>
      <ul>
        <li>Todas las comunicaciones via HTTPS (TLS 1.3)</li>
        <li>Passwords con bcrypt (salt rounds: 12)</li>
        <li>JWT con expiraci√≥n 8h + refresh token</li>
        <li>API Keys hasheadas en DB (nunca en claro)</li>
        <li>Webhook 360dialog verificado con HMAC-SHA256</li>
        <li>Rate limiting en todos los endpoints p√∫blicos</li>
        <li>Aislamiento total de datos por <code>clinica_id</code></li>
        <li>Logs sin datos personales en texto claro</li>
      </ul>
    </div>
    <div class="card">
      <h3>Obligaciones RGPD</h3>
      <ul>
        <li>Acuerdo de encargado de tratamiento (DPA) firmado con cada cl√≠nica</li>
        <li>Los pacientes deben haber dado consentimiento para recibir WhatsApps</li>
        <li>Opci√≥n de baja en todos los mensajes (<code>STOP</code>)</li>
        <li>Datos almacenados en servidores dentro de la UE</li>
        <li>Pol√≠tica de retenci√≥n: logs eliminados a los 90 d√≠as</li>
        <li>Derecho al olvido: endpoint <code>DELETE /pacientes/:id</code></li>
      </ul>
    </div>
  </div>

  <div class="alert alert-warn">
    ‚ö†Ô∏è <span><strong>Importante:</strong> WhatsApp Business Platform solo permite enviar mensajes a usuarios que hayan iniciado conversaci√≥n en las √∫ltimas 24h, o usando <strong>Message Templates</strong> aprobados por Meta. Los recordatorios de cita deben enviarse usando una plantilla aprobada.</span>
  </div>

  <h3>Template de WhatsApp aprobado (ejemplo)</h3>
  <pre>
Nombre: dental_reminder_es
Idioma: es_ES
Categor√≠a: UTILITY
Cuerpo:
  "Hola {{1}} üëã Te recordamos tu cita en {{2}} el {{3}} a las {{4}}
   con {{5}}. ¬øConfirmas tu asistencia?
   Responde S√ç para confirmar o NO para cancelar."

Variables: [nombre_paciente, nombre_clinica, dia, hora, dentista]
  </pre>
</div>

<!-- 9. ESTIMACI√ìN DE DESARROLLO -->
<div class="page">
  <div class="section-label">Secci√≥n 9</div>
  <h2>Estimaci√≥n de desarrollo ‚Äî MVP</h2>

  <table>
    <thead><tr><th>M√≥dulo</th><th>Descripci√≥n</th><th>Estimaci√≥n</th><th>Prioridad</th></tr></thead>
    <tbody>
      <tr><td><strong>Setup inicial</strong></td><td>Proyecto, DB, Railway, 360dialog, estructura multi-tenant</td><td>1 d√≠a</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>Schema DB</strong></td><td>Migraciones, √≠ndices, seed de datos de prueba</td><td>0.5 d√≠as</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>Auth multi-tenant</strong></td><td>Login, JWT, middleware de aislamiento por cl√≠nica</td><td>1 d√≠a</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>Integration Layer</strong></td><td>Importaci√≥n CSV + webhook de agenda entrante</td><td>1.5 d√≠as</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>Motor WhatsApp</strong></td><td>Env√≠o/recepci√≥n via 360dialog, webhook handler</td><td>1.5 d√≠as</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>Scheduler</strong></td><td>Bull + Redis, cron de recordatorios y rese√±as</td><td>1 d√≠a</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>Flujos de conversaci√≥n</strong></td><td>Confirmaci√≥n, cancelaci√≥n, FAQ, rese√±a</td><td>2 d√≠as</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>Panel de control</strong></td><td>Dashboard cl√≠nica: m√©tricas, citas, log mensajes</td><td>2 d√≠as</td><td><span class="badge badge-yellow">Media</span></td></tr>
      <tr><td><strong>Templates WhatsApp</strong></td><td>Creaci√≥n y aprobaci√≥n de plantillas en Meta</td><td>1-3 d√≠as</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>Testing + QA</strong></td><td>Pruebas con cl√≠nica piloto real</td><td>2 d√≠as</td><td><span class="badge badge-yellow">Media</span></td></tr>
    </tbody>
  </table>

  <div class="card" style="margin-top:1.25rem">
    <h3>‚è±Ô∏è Total estimado MVP: 12-15 d√≠as de desarrollo</h3>
    <p style="margin-top:.5rem;color:var(--muted);font-size:.875rem">Con un desarrollador senior full-stack. El cuello de botella real es la aprobaci√≥n de templates por Meta (1-3 d√≠as h√°biles) y la integraci√≥n con la agenda de la primera cl√≠nica piloto.</p>
  </div>

  <h3>Orden de desarrollo recomendado</h3>
  <ol>
    <li>Setup + DB + Auth multi-tenant</li>
    <li>Webhook 360dialog + env√≠o de mensajes b√°sico</li>
    <li>Importaci√≥n CSV de agenda</li>
    <li>Flujo de recordatorio + confirmaci√≥n</li>
    <li>Flujo de rese√±a</li>
    <li>FAQ autom√°tico</li>
    <li>Panel de control b√°sico</li>
    <li>Prueba piloto con primera cl√≠nica</li>
  </ol>
</div>

<!-- 10. CHECKLIST ANTES DE PRODUCCI√ìN -->
<div class="page">
  <div class="section-label">Secci√≥n 10</div>
  <h2>Checklist antes de lanzar con primer cliente</h2>

  <div class="grid-2">
    <div class="card">
      <h3>Infraestructura</h3>
      <ul>
        <li>‚òê PostgreSQL en producci√≥n con backups autom√°ticos</li>
        <li>‚òê Redis configurado y persistente</li>
        <li>‚òê Variables de entorno en Railway (nunca en c√≥digo)</li>
        <li>‚òê Dominio propio con SSL (api.ainertia.ai)</li>
        <li>‚òê Monitorizaci√≥n con UptimeRobot o similar</li>
        <li>‚òê Alertas de error por email/Slack</li>
      </ul>
    </div>
    <div class="card">
      <h3>WhatsApp / Meta</h3>
      <ul>
        <li>‚òê Cuenta de negocio verificada en Meta Business</li>
        <li>‚òê N√∫mero de tel√©fono aprobado en 360dialog</li>
        <li>‚òê Templates de mensajes aprobados por Meta</li>
        <li>‚òê Webhook configurado y verificado</li>
        <li>‚òê Prueba de env√≠o y recepci√≥n confirmada</li>
      </ul>
    </div>
    <div class="card">
      <h3>Legal / RGPD</h3>
      <ul>
        <li>‚òê DPA firmado con la cl√≠nica</li>
        <li>‚òê Confirmaci√≥n de que pacientes han dado consentimiento</li>
        <li>‚òê Opci√≥n STOP implementada</li>
        <li>‚òê Pol√≠tica de privacidad actualizada</li>
      </ul>
    </div>
    <div class="card">
      <h3>Cl√≠nica piloto</h3>
      <ul>
        <li>‚òê Formato de exportaci√≥n de agenda acordado</li>
        <li>‚òê Horarios y mensajes personalizados configurados</li>
        <li>‚òê N√∫mero de Google Maps verificado para rese√±as</li>
        <li>‚òê Formaci√≥n b√°sica al equipo de recepci√≥n</li>
        <li>‚òê Prueba completa del flujo con paciente real</li>
      </ul>
    </div>
  </div>
</div>

<!-- FOOTER -->
<div class="doc-footer">
  <span>Ainertia Capital S.L. ¬∑ CIF B75739656 ¬∑ C√≥rdoba, Espa√±a</span>
  <span>Documento t√©cnico confidencial ¬∑ v1.0 ¬∑ Febrero 2026</span>
</div>

</body>
</html>
