<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EspecificaciÃ³n TÃ©cnica v2.0 â€” AutomatizaciÃ³n WhatsApp para ClÃ­nicas Dentales | Ainertia Capital</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --blue: #1a6fb5; --blue-light: #e8f3fc; --teal: #0fa98e;
      --dark: #1a2332; --text: #2c3e50; --muted: #6b7c93;
      --border: #e2e8f0; --bg: #f8fafc; --code-bg: #1e2d3d;
    }
    body { font-family: 'Segoe UI', system-ui, sans-serif; color: var(--text); background: #fff; font-size: 14px; line-height: 1.65; max-width: 860px; margin: 0 auto; }

    /* COVER */
    .cover { background: linear-gradient(160deg, #1a2332 0%, #1e3a5f 100%); color: #fff; padding: 60px; page-break-after: always; }
    .cover-logo { font-size: 1.2rem; font-weight: 800; margin-bottom: 50px; }
    .cover-logo span { color: var(--teal); }
    .cover-tag { display: inline-block; background: rgba(15,169,142,.2); border: 1px solid rgba(15,169,142,.4); color: var(--teal); border-radius: 100px; padding: .25rem .875rem; font-size: .7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1.25rem; }
    .cover h1 { font-size: 2rem; font-weight: 900; line-height: 1.2; margin-bottom: 1rem; }
    .cover h1 em { color: var(--teal); font-style: normal; }
    .cover-sub { color: rgba(255,255,255,.6); font-size: .95rem; max-width: 500px; margin-bottom: 50px; }
    .cover-meta { display: flex; gap: 2rem; flex-wrap: wrap; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,.12); }
    .cover-meta-item { font-size: .72rem; color: rgba(255,255,255,.5); }
    .cover-meta-item strong { display: block; font-size: .82rem; color: rgba(255,255,255,.85); font-weight: 600; margin-bottom: .1rem; }

    /* LAYOUT */
    .page { padding: 40px 60px; }
    .page + .page { border-top: 2px solid var(--border); }
    .section-label { font-size: .65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: var(--teal); margin-bottom: .4rem; }
    h2 { font-size: 1.4rem; font-weight: 800; color: var(--dark); line-height: 1.2; margin-bottom: .75rem; }
    h3 { font-size: 1rem; font-weight: 700; color: var(--dark); margin-bottom: .4rem; margin-top: 1.25rem; }
    h4 { font-size: .875rem; font-weight: 700; color: var(--blue); margin-bottom: .3rem; margin-top: 1rem; }
    p { margin-bottom: .75rem; }
    p:last-child { margin-bottom: 0; }
    ul, ol { padding-left: 1.25rem; margin-bottom: .75rem; }
    li { margin-bottom: .3rem; font-size: .875rem; }

    /* CODE */
    pre {
      background: var(--code-bg); color: #e2e8f0; border-radius: 10px;
      padding: 1.25rem 1.5rem; font-family: 'Courier New', monospace;
      font-size: .8rem; line-height: 1.7; overflow-x: auto;
      margin: .875rem 0; white-space: pre;
    }
    code { background: #f1f5f9; color: var(--blue); padding: .1rem .35rem; border-radius: 4px; font-size: .82rem; font-family: 'Courier New', monospace; }

    /* CARDS */
    .card { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; }
    .card h3 { margin-top: 0; }

    /* GRID */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin: 1rem 0; }

    /* PROVIDER CARDS */
    .provider-card {
      border: 2px solid var(--border); border-radius: 14px; padding: 1.5rem;
      transition: border-color 0.2s;
    }
    .provider-card.meta { border-left: 5px solid var(--blue); }
    .provider-card.qr   { border-left: 5px solid var(--teal); }
    .provider-header { display: flex; align-items: center; gap: .75rem; margin-bottom: .875rem; }
    .provider-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
    .provider-icon.meta { background: var(--blue-light); }
    .provider-icon.qr   { background: #e6f7f4; }
    .provider-name { font-weight: 800; font-size: .95rem; color: var(--dark); }
    .provider-sub  { font-size: .78rem; color: var(--muted); }

    /* PLAN TABLE */
    .plan-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: var(--border); border-radius: 14px; overflow: hidden; margin: 1rem 0; }
    .plan-col { background: #fff; padding: 1.25rem; }
    .plan-col.featured { background: #f0f7ff; }
    .plan-name { font-weight: 800; font-size: .95rem; color: var(--dark); margin-bottom: .2rem; }
    .plan-price { font-size: 1.5rem; font-weight: 900; color: var(--blue); margin-bottom: .5rem; }
    .plan-price span { font-size: .8rem; font-weight: 500; color: var(--muted); }
    .plan-feat { font-size: .78rem; color: var(--text); line-height: 1.7; }
    .plan-feat li { list-style: none; padding-left: 0; }
    .plan-feat li::before { content: "âœ“ "; color: var(--teal); font-weight: 700; }
    .plan-feat li.no::before { content: "â€” "; color: var(--border); }

    /* STACK */
    .stack-item { display: flex; gap: .875rem; align-items: flex-start; padding: .875rem 1rem; border: 1px solid var(--border); border-radius: 10px; margin-bottom: .625rem; }
    .stack-badge { background: var(--blue); color: #fff; border-radius: 8px; padding: .3rem .7rem; font-size: .7rem; font-weight: 700; white-space: nowrap; flex-shrink: 0; }
    .stack-badge.alt { background: var(--teal); }
    .stack-badge.warn { background: #f59e0b; }
    .stack-item p { font-size: .82rem; color: var(--muted); margin: .2rem 0 0; }

    /* FLOW */
    .flow { background: var(--code-bg); color: #e2e8f0; border-radius: 12px; padding: 1.5rem; font-family: 'Courier New', monospace; font-size: .8rem; line-height: 2; margin: 1rem 0; }
    .flow .step   { color: #93c5fd; }
    .flow .action { color: #6ee7b7; }
    .flow .cond   { color: #fde68a; }
    .flow .arrow  { color: #64748b; }

    /* TABLE */
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: .82rem; }
    th { background: var(--bg); text-align: left; padding: .625rem .875rem; border-bottom: 2px solid var(--border); font-size: .72rem; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); }
    td { padding: .625rem .875rem; border-bottom: 1px solid var(--border); vertical-align: top; }
    tr:last-child td { border-bottom: none; }

    /* BADGE */
    .badge { display: inline-block; border-radius: 100px; padding: .15rem .6rem; font-size: .68rem; font-weight: 600; }
    .badge-blue   { background: var(--blue-light); color: var(--blue); }
    .badge-green  { background: #dcfce7; color: #16a34a; }
    .badge-yellow { background: #fef9c3; color: #a16207; }
    .badge-red    { background: #fee2e2; color: #dc2626; }
    .badge-teal   { background: #e6f7f4; color: #0f766e; }

    /* ALERT */
    .alert { border-radius: 10px; padding: .875rem 1rem; margin: .875rem 0; font-size: .82rem; display: flex; gap: .625rem; }
    .alert-info     { background: var(--blue-light); border: 1px solid #bfdbfe; color: #1e40af; }
    .alert-warn     { background: #fef9c3; border: 1px solid #fde68a; color: #92400e; }
    .alert-critical { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; }
    .alert-success  { background: #dcfce7; border: 1px solid #bbf7d0; color: #166534; }

    /* FOOTER */
    .doc-footer { padding: 1.25rem 60px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; font-size: .7rem; color: var(--muted); }

    @media print {
      body { max-width: 100%; }
      .cover { page-break-after: always; }
      .page { page-break-inside: avoid; }
      @page { margin: 0; size: A4; }
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PORTADA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="cover">
  <div class="cover-logo">Ainertia<span>.</span></div>
  <div class="cover-tag">EspecificaciÃ³n TÃ©cnica v2.0</div>
  <h1>Sistema de <em>automatizaciÃ³n WhatsApp</em><br/>para clÃ­nicas dentales</h1>
  <p class="cover-sub">Arquitectura, flujos, stack tecnolÃ³gico e integraciones para el equipo de desarrollo. ImplementaciÃ³n 100% en Node.js, sin dependencias externas de automatizaciÃ³n.</p>
  <div class="cover-meta">
    <div class="cover-meta-item"><strong>Proyecto</strong>Ainertia Dental Automation</div>
    <div class="cover-meta-item"><strong>VersiÃ³n</strong>2.0 â€” ProducciÃ³n</div>
    <div class="cover-meta-item"><strong>Audiencia</strong>Equipo IT / Desarrollo</div>
    <div class="cover-meta-item"><strong>Fecha</strong>Febrero 2026</div>
    <div class="cover-meta-item"><strong>Contacto tÃ©cnico</strong>tech@ainertia.ai</div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECCIÃ“N 1 â€” RESUMEN Y PLANES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page">
  <div class="section-label">SecciÃ³n 1</div>
  <h2>Resumen del sistema y planes comerciales</h2>

  <p>El sistema automatiza la comunicaciÃ³n entre clÃ­nicas dentales y sus pacientes a travÃ©s de WhatsApp. Gestiona el ciclo completo: <strong>recordatorio de cita â†’ confirmaciÃ³n â†’ cancelaciÃ³n â†’ solicitud de reseÃ±a â†’ FAQ automÃ¡tico</strong>.</p>
  <p>Es <strong>multi-tenant</strong>: una Ãºnica instancia sirve a mÃºltiples clÃ­nicas. Toda la lÃ³gica de automatizaciÃ³n estÃ¡ implementada en <strong>Node.js nativo</strong>, sin dependencias de herramientas de automatizaciÃ³n externas.</p>

  <h3>Planes disponibles</h3>
  <div class="plan-grid">
    <div class="plan-col">
      <div class="plan-name">ğŸª„ BÃ¡sico</div>
      <div class="plan-price">149â‚¬<span>/mes</span></div>
      <ul class="plan-feat">
        <li>ConexiÃ³n WhatsApp mediante QR</li>
        <li>Recordatorios 24h antes</li>
        <li>ConfirmaciÃ³n / CancelaciÃ³n</li>
        <li>Solicitud de reseÃ±a Google</li>
        <li>Agenda via CSV (subida manual)</li>
        <li>Panel de control bÃ¡sico</li>
        <li>1 nÃºmero WhatsApp</li>
        <li class="no">Google Calendar</li>
        <li class="no">FAQ con IA</li>
        <li class="no">IntegraciÃ³n software clÃ­nica</li>
      </ul>
    </div>
    <div class="plan-col featured">
      <div class="plan-name">âš¡ Profesional</div>
      <div class="plan-price">249â‚¬<span>/mes</span></div>
      <ul class="plan-feat">
        <li>WhatsApp: QR <strong>o</strong> nÃºmero verificado Meta (a elegir)</li>
        <li>Todo lo de BÃ¡sico</li>
        <li>FAQ automÃ¡tico con IA</li>
        <li>IntegraciÃ³n Google Calendar</li>
        <li>Panel con mÃ©tricas avanzadas</li>
        <li>Mensajes personalizados por clÃ­nica</li>
        <li>Notificaciones a recepciÃ³n</li>
        <li>Soporte prioritario</li>
        <li class="no">IntegraciÃ³n software clÃ­nica</li>
        <li class="no">Multi-sede</li>
      </ul>
    </div>
    <div class="plan-col">
      <div class="plan-name">ğŸ¢ Avanzado</div>
      <div class="plan-price">399â‚¬<span>/mes</span></div>
      <ul class="plan-feat">
        <li>NÃºmero verificado Meta (recomendado)</li>
        <li>Todo lo de Profesional</li>
        <li>IntegraciÃ³n nativa software clÃ­nica</li>
        <li>Multi-sede (hasta 5 consultas)</li>
        <li>Informes automÃ¡ticos mensuales</li>
        <li>API de integraciÃ³n propia</li>
        <li>Onboarding dedicado</li>
        <li>SLA 99.5% uptime</li>
        <li>Gestor de cuenta asignado</li>
      </ul>
    </div>
  </div>

  <div class="alert alert-info">
    â„¹ï¸ <span>La elecciÃ³n del proveedor WhatsApp (QR vs. nÃºmero verificado Meta) estÃ¡ disponible en planes Profesional y Avanzado. El plan BÃ¡sico incluye Ãºnicamente conexiÃ³n mediante QR.</span>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECCIÃ“N 2 â€” MÃ“DULO WHATSAPP: DOS PROVEEDORES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page">
  <div class="section-label">SecciÃ³n 2</div>
  <h2>MÃ³dulo WhatsApp: dos modos de conexiÃ³n</h2>

  <p>El sistema ofrece dos modos de conexiÃ³n a WhatsApp. La clÃ­nica elige en el momento del onboarding cuÃ¡l se adapta mejor a su situaciÃ³n. La lÃ³gica de envÃ­o/recepciÃ³n de mensajes es idÃ©ntica en ambos; solo cambia el adaptador de transporte.</p>

  <div class="grid-2" style="margin-top:1.25rem">

    <!-- META API -->
    <div class="provider-card meta">
      <div class="provider-header">
        <div class="provider-icon meta">ğŸ”·</div>
        <div>
          <div class="provider-name">NÃºmero verificado Meta</div>
          <div class="provider-sub">WhatsApp Business API oficial</div>
        </div>
      </div>
      <ul style="font-size:.82rem;padding-left:1.1rem;margin-bottom:.875rem">
        <li>NÃºmero de telÃ©fono aprobado por Meta</li>
        <li>EnvÃ­o masivo sin riesgo de suspensiÃ³n</li>
        <li>Plantillas de mensajes aprobadas (mayor confianza del destinatario)</li>
        <li>Registro de Business Manager obligatorio</li>
        <li>Proceso de verificaciÃ³n: 24-72h hÃ¡biles</li>
        <li>Sin dependencia de tener el mÃ³vil conectado</li>
        <li>Requiere acuerdo con proveedor BSP (360dialog recomendado)</li>
      </ul>
      <div style="font-size:.75rem;color:var(--muted)">
        <strong>Ideal para:</strong> Plan Profesional/Avanzado, clÃ­nicas con alto volumen de citas (>30/dÃ­a), mÃºltiples dentistas, cadenas.
      </div>
    </div>

    <!-- QR -->
    <div class="provider-card qr">
      <div class="provider-header">
        <div class="provider-icon qr">ğŸ“±</div>
        <div>
          <div class="provider-name">ConexiÃ³n mediante QR</div>
          <div class="provider-sub">NÃºmero WhatsApp existente de la clÃ­nica</div>
        </div>
      </div>
      <ul style="font-size:.82rem;padding-left:1.1rem;margin-bottom:.875rem">
        <li>La clÃ­nica usa su propio nÃºmero WhatsApp actual</li>
        <li>ActivaciÃ³n en minutos: escanear QR desde el panel</li>
        <li>Sin procesos de verificaciÃ³n con Meta</li>
        <li>Sin coste adicional de proveedor BSP</li>
        <li>Funciona con nÃºmero de empresa o personal</li>
        <li>SesiÃ³n persistente: no requiere mÃ³vil activo</li>
        <li>Adecuado para clÃ­nicas de bajo/medio volumen</li>
      </ul>
      <div style="font-size:.75rem;color:var(--muted)">
        <strong>Ideal para:</strong> Plan BÃ¡sico/Profesional, clÃ­nicas pequeÃ±as, onboarding rÃ¡pido sin trÃ¡mites.
      </div>
    </div>
  </div>

  <h3>Arquitectura del mÃ³dulo WhatsApp</h3>
  <p>Internamente se usa el patrÃ³n <strong>Adapter</strong>: la lÃ³gica de negocio llama a una interfaz comÃºn y el adaptador concreto gestiona el protocolo de cada proveedor.</p>

  <pre>
// services/whatsapp/WhatsAppAdapter.js â€” interfaz comÃºn
class WhatsAppAdapter {
  async sendMessage(to, body)       { throw new Error('Not implemented'); }
  async sendTemplate(to, template)  { throw new Error('Not implemented'); }
  async isConnected()               { throw new Error('Not implemented'); }
}

// services/whatsapp/MetaAdapter.js  â€” proveedor oficial
class MetaAdapter extends WhatsAppAdapter {
  constructor(clinica) {
    super();
    this.apiKey   = clinica.wa_api_key;
    this.phoneId  = clinica.wa_phone_id;
    this.baseUrl  = 'https://waba.360dialog.io/v1';
  }
  async sendMessage(to, body) {
    return fetch(`${this.baseUrl}/messages`, {
      method: 'POST',
      headers: { 'D360-API-KEY': this.apiKey, 'Content-Type': 'application/json' },
      body: JSON.stringify({ to, type: 'text', text: { body } })
    });
  }
  async sendTemplate(to, { name, lang, vars }) {
    // EnvÃ­a template pre-aprobado por Meta (obligatorio fuera de la ventana 24h)
    return fetch(`${this.baseUrl}/messages`, {
      method: 'POST',
      headers: { 'D360-API-KEY': this.apiKey, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        to, type: 'template',
        template: { name, language: { code: lang },
          components: [{ type: 'body', parameters: vars.map(v => ({ type: 'text', text: v })) }] }
      })
    });
  }
}

// services/whatsapp/QRAdapter.js â€” conexiÃ³n mediante QR
class QRAdapter extends WhatsAppAdapter {
  constructor(clinica, sessionStore) {
    super();
    this.clinicaId   = clinica.id;
    this.sessionStore = sessionStore;  // credenciales de sesiÃ³n en DB
    this.socket       = null;          // referencia al socket activo
  }
  async sendMessage(to, body) {
    const jid = to.replace(/\D/g, '') + '@s.whatsapp.net';
    return this.socket.sendMessage(jid, { text: body });
  }
  async sendTemplate(to, { body }) {
    // En modo QR los templates se envÃ­an como texto libre
    return this.sendMessage(to, body);
  }
}

// services/whatsapp/WhatsAppFactory.js â€” selecciÃ³n automÃ¡tica por clÃ­nica
function createAdapter(clinica, sessionStore) {
  if (clinica.wa_provider === 'meta') return new MetaAdapter(clinica);
  if (clinica.wa_provider === 'qr')   return new QRAdapter(clinica, sessionStore);
  throw new Error(`Proveedor desconocido: ${clinica.wa_provider}`);
}
  </pre>

  <h3>GestiÃ³n del QR desde el panel de administraciÃ³n</h3>
  <p>Las clÃ­nicas con modo QR disponen de una pantalla de configuraciÃ³n en su panel donde:</p>
  <ol>
    <li>Pulsan <strong>"Conectar WhatsApp"</strong></li>
    <li>Se muestra un cÃ³digo QR generado en tiempo real vÃ­a WebSocket</li>
    <li>El responsable de la clÃ­nica escanea el QR con su telÃ©fono desde <em>WhatsApp â†’ Dispositivos vinculados</em></li>
    <li>La sesiÃ³n queda activa y se persiste en base de datos (reconexiÃ³n automÃ¡tica)</li>
    <li>Un indicador verde confirma el estado de conexiÃ³n en todo momento</li>
  </ol>

  <div class="alert alert-warn">
    âš ï¸ <span><strong>Modo QR â€” LimitaciÃ³n importante:</strong> WhatsApp aplica restricciones de volumen en cuentas no verificadas. Para clÃ­nicas que superen ~50 mensajes/dÃ­a se recomienda migrar al modo nÃºmero verificado Meta para evitar suspensiones. El sistema detecta el volumen y avisa proactivamente.</span>
  </div>

  <h3>Campos en DB segÃºn proveedor</h3>
  <pre>
-- Campo wa_provider en tabla clinicas
ALTER TABLE clinicas ADD COLUMN wa_provider VARCHAR(10) DEFAULT 'qr';
  -- Valores: 'qr' | 'meta'

ALTER TABLE clinicas ADD COLUMN wa_phone_id  VARCHAR(50);   -- Solo Meta: phone_number_id
ALTER TABLE clinicas ADD COLUMN wa_api_key   TEXT;          -- Solo Meta: API key 360dialog

-- Tabla para sesiones QR persistidas
CREATE TABLE wa_sessions (
  clinica_id   UUID PRIMARY KEY REFERENCES clinicas(id) ON DELETE CASCADE,
  creds_json   TEXT NOT NULL,   -- credenciales de sesiÃ³n cifradas (AES-256)
  connected    BOOLEAN DEFAULT false,
  last_seen    TIMESTAMPTZ,
  updated_at   TIMESTAMPTZ DEFAULT NOW()
);
  </pre>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECCIÃ“N 3 â€” ARQUITECTURA GENERAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page">
  <div class="section-label">SecciÃ³n 3</div>
  <h2>Arquitectura del sistema</h2>

  <div class="flow">
<span class="step">[AGENDA CLÃNICA]</span>
  CSV manual / Google Calendar / API nativa
          â”‚
          â–¼
<span class="action">[AINERTIA CORE â€” Node.js + PostgreSQL]</span>
  â”œâ”€â”€ Scheduler Engine  (node-cron + Bull Queue)
  â”œâ”€â”€ Conversation Manager (mÃ¡quina de estados)
  â”œâ”€â”€ WhatsApp Factory  (selecciÃ³n Meta o QR por clÃ­nica)
  â”œâ”€â”€ AI FAQ Engine     (OpenAI GPT-4o-mini)
  â””â”€â”€ REST API          (panel de control por clÃ­nica)
          â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                                  â–¼
<span class="step">[WHATSAPP â€” MetaAdapter]</span>        <span class="step">[WHATSAPP â€” QRAdapter]</span>
  360dialog API â†’ Meta Cloud API       ConexiÃ³n multidispositivo
  Plantillas aprobadas                 QR escaneado desde panel
          â”‚                                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
              <span class="step">[PACIENTE]</span>  (recibe + responde por WhatsApp)
                         â”‚
              <span class="cond">[MOTOR DE DECISIÃ“N â€” Node.js nativo]</span>
                â”œâ”€â”€ Confirmar  â†’ actualizar cita en DB
                â”œâ”€â”€ Cancelar   â†’ notificar recepciÃ³n + liberar hueco
                â”œâ”€â”€ Reagendar  â†’ flujo de selecciÃ³n de horario
                â””â”€â”€ FAQ / libre â†’ GPT-4o-mini con contexto clÃ­nica
  </div>

  <h3>Componentes principales</h3>
  <table>
    <thead><tr><th>Componente</th><th>Responsabilidad</th><th>TecnologÃ­a</th></tr></thead>
    <tbody>
      <tr><td><strong>Core API</strong></td><td>LÃ³gica de negocio, multi-tenant, gestiÃ³n de citas</td><td>Node.js / Express</td></tr>
      <tr><td><strong>WhatsApp Factory</strong></td><td>EnvÃ­o/recepciÃ³n. Selecciona Meta o QR segÃºn clÃ­nica</td><td>Node.js (ver Â§2)</td></tr>
      <tr><td><strong>Scheduler</strong></td><td>Cron jobs para recordatorios y reseÃ±as</td><td>node-cron + Bull + Redis</td></tr>
      <tr><td><strong>Conversation Manager</strong></td><td>MÃ¡quina de estados por conversaciÃ³n activa</td><td>Node.js + PostgreSQL</td></tr>
      <tr><td><strong>AI FAQ Engine</strong></td><td>Respuestas automÃ¡ticas a preguntas libres</td><td>OpenAI GPT-4o-mini</td></tr>
      <tr><td><strong>Integration Layer</strong></td><td>Lectura de agenda (CSV / Google Calendar / API)</td><td>Node.js adapters</td></tr>
      <tr><td><strong>Panel de Control</strong></td><td>Dashboard por clÃ­nica + panel superadmin</td><td>React / Next.js</td></tr>
      <tr><td><strong>Base de Datos</strong></td><td>Persistencia principal multi-tenant</td><td>PostgreSQL</td></tr>
      <tr><td><strong>Queue</strong></td><td>Cola de mensajes, reintentos, rate limiting</td><td>Bull + Redis</td></tr>
    </tbody>
  </table>

  <div class="alert alert-success">
    âœ… <span><strong>Sin n8n ni herramientas de automatizaciÃ³n externas.</strong> Toda la lÃ³gica de flujos, scheduling y decisiones de conversaciÃ³n estÃ¡ implementada en Node.js puro, lo que elimina dependencias externas, reduce costes de infraestructura y simplifica el despliegue.</span>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECCIÃ“N 4 â€” INTEGRACIÃ“N CON LA AGENDA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page">
  <div class="section-label">SecciÃ³n 4</div>
  <h2>IntegraciÃ³n con la agenda de la clÃ­nica</h2>

  <p>El mÃ©todo de integraciÃ³n depende del <strong>plan contratado</strong>. Todos los mÃ©todos convergen en el mismo modelo interno de datos (tabla <code>citas</code>). El sistema admite mÃºltiples mÃ©todos activos simultÃ¡neamente.</p>

  <table>
    <thead>
      <tr><th>MÃ©todo</th><th>Plan requerido</th><th>Esfuerzo implantaciÃ³n</th><th>RecomendaciÃ³n</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>A â€” CSV manual</strong></td>
        <td><span class="badge badge-blue">BÃ¡sico+</span></td>
        <td>MÃ­nimo</td>
        <td>MVP, primera clÃ­nica</td>
      </tr>
      <tr>
        <td><strong>B â€” Webhook entrante</strong></td>
        <td><span class="badge badge-blue">BÃ¡sico+</span></td>
        <td>Bajo (script en la clÃ­nica)</td>
        <td>ClÃ­nicas con IT propio</td>
      </tr>
      <tr>
        <td><strong>C â€” Google Calendar</strong></td>
        <td><span class="badge badge-teal">Profesional+</span></td>
        <td>Medio (OAuth2)</td>
        <td>ClÃ­nicas pequeÃ±as/medianas</td>
      </tr>
      <tr>
        <td><strong>D â€” Software clÃ­nica (API/DB)</strong></td>
        <td><span class="badge badge-yellow">Avanzado</span></td>
        <td>Alto (acuerdo con proveedor)</td>
        <td>Gesden, Cliniccloud, RCDent</td>
      </tr>
    </tbody>
  </table>

  <!-- MÃ‰TODO A -->
  <h3>MÃ©todo A â€” ImportaciÃ³n CSV/Excel (todos los planes)</h3>
  <p>La clÃ­nica exporta su agenda desde su software habitual y la sube al panel de Ainertia (arrastra el fichero o programa una subida automÃ¡tica vÃ­a Google Drive / Dropbox).</p>
  <pre>
# Formato CSV esperado
fecha_hora,paciente_nombre,paciente_telefono,dentista,tipo_cita,duracion_min
2026-03-15 10:30,Ana GarcÃ­a,+34612345678,Dr. FernÃ¡ndez,Limpieza,45
2026-03-15 11:30,Luis MartÃ­n,612345678,Dra. Ruiz,RevisiÃ³n,30

# Endpoint de importaciÃ³n
POST /api/v1/clinicas/:clinica_id/agenda/import
Authorization: Bearer {jwt_token}
Content-Type: multipart/form-data
Body: { file: agenda.csv }

# El sistema normaliza telÃ©fonos a E.164 (+34XXXXXXXXX)
# Crea pacientes nuevos si el telÃ©fono no existe
# Actualiza citas existentes (ext_id como clave de deduplicaciÃ³n)
  </pre>

  <!-- MÃ‰TODO B -->
  <h3>MÃ©todo B â€” Webhook push desde agenda (todos los planes)</h3>
  <p>El software de la clÃ­nica (o un script intermedio) notifica a Ainertia en tiempo real cada vez que se crea, modifica o cancela una cita.</p>
  <pre>
POST /api/v1/webhooks/cita
Authorization: Bearer {api_key_clinica}
Content-Type: application/json

{
  "evento": "cita_creada",       // cita_creada | cita_modificada | cita_cancelada | cita_completada
  "ext_id": "GESDEN-20260315-001",
  "paciente": {
    "nombre": "Ana GarcÃ­a",
    "telefono": "+34612345678",
    "email": "ana@example.com"   // opcional
  },
  "cita": {
    "fecha_hora": "2026-03-15T10:30:00+01:00",
    "duracion_min": 45,
    "tipo": "Limpieza",
    "dentista": "Dr. FernÃ¡ndez"
  }
}

// Respuesta
{ "ok": true, "cita_id": "uuid-ainertia" }
  </pre>

  <!-- MÃ‰TODO C -->
  <h3>MÃ©todo C â€” Google Calendar (plan Profesional y Avanzado)</h3>
  <p>La clÃ­nica vincula su Google Calendar mediante OAuth2. Ainertia lee los eventos como citas y opcionalmente escribe actualizaciones de estado (confirmada/cancelada) de vuelta al calendar.</p>
  <pre>
// Flujo OAuth2
1. ClÃ­nica pulsa "Conectar Google Calendar" en el panel
2. RedirecciÃ³n a Google OAuth2 consent screen
3. Ainertia recibe authorization code
4. Intercambio por access_token + refresh_token (almacenados cifrados en DB)
5. Ainertia subscribe a push notifications del calendar (webhook Google)

// SincronizaciÃ³n
GET https://www.googleapis.com/calendar/v3/calendars/{calendarId}/events
  ?timeMin={ahora}
  &timeMax={ahora + 48h}
  &singleEvents=true
  &orderBy=startTime

// Mapeo de campos esperado (configurable por clÃ­nica):
event.summary         â†’ tipo_cita + dentista
event.description     â†’ paciente_nombre, paciente_telefono (regex configurable)
event.start.dateTime  â†’ fecha_hora
event.end.dateTime    â†’ fecha_hora + duracion_min

// Variables de entorno requeridas
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GOOGLE_REDIRECT_URI=https://api.ainertia.ai/auth/google/callback
  </pre>
  <div class="alert alert-warn">
    âš ï¸ <span>El formato de los eventos de Google Calendar varÃ­a segÃºn cÃ³mo cada clÃ­nica los haya nombrado. El mapeo de campos (dÃ³nde estÃ¡ el telÃ©fono del paciente, el dentista, etc.) es <strong>configurable por clÃ­nica</strong> desde el panel de administraciÃ³n de Ainertia.</span>
  </div>

  <!-- MÃ‰TODO D -->
  <h3>MÃ©todo D â€” Software de gestiÃ³n dental (plan Avanzado)</h3>
  <p>IntegraciÃ³n nativa con los principales programas de gestiÃ³n dental del mercado espaÃ±ol. Requiere acceso tÃ©cnico al servidor de la clÃ­nica y acuerdo firmado con el proveedor del software.</p>
  <table>
    <thead><tr><th>Software</th><th>MÃ©todo disponible</th><th>Complejidad</th></tr></thead>
    <tbody>
      <tr><td><strong>Cliniccloud</strong></td><td>API REST documentada (token OAuth2)</td><td><span class="badge badge-green">Bajo</span></td></tr>
      <tr><td><strong>Gesden</strong></td><td>ExportaciÃ³n automÃ¡tica a fichero (SFTP/carpeta compartida)</td><td><span class="badge badge-yellow">Medio</span></td></tr>
      <tr><td><strong>RCDent</strong></td><td>Acceso directo a BD SQL Server (con permiso)</td><td><span class="badge badge-red">Alto</span></td></tr>
      <tr><td><strong>Oris / Dental Lab</strong></td><td>Webhook personalizado + script de integraciÃ³n</td><td><span class="badge badge-yellow">Medio</span></td></tr>
    </tbody>
  </table>
  <div class="alert alert-critical">
    ğŸ”´ <span>El acceso directo a base de datos del software de la clÃ­nica <strong>requiere acuerdo firmado</strong> con la clÃ­nica y revisiÃ³n legal. Implementar solo en plan Avanzado con cliente que lo solicite explÃ­citamente.</span>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECCIÃ“N 5 â€” STACK TECNOLÃ“GICO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page">
  <div class="section-label">SecciÃ³n 5</div>
  <h2>Stack tecnolÃ³gico</h2>

  <div class="stack-item">
    <span class="stack-badge">Backend</span>
    <div><strong>Node.js 22 + Express</strong>
    <p>API REST principal. Gestiona webhooks de WhatsApp, lÃ³gica multi-tenant, scheduling de mensajes y conexiÃ³n a DB. Sin frameworks de automatizaciÃ³n externos.</p></div>
  </div>
  <div class="stack-item">
    <span class="stack-badge">Base de datos</span>
    <div><strong>PostgreSQL 16+</strong>
    <p>ClÃ­nicas, pacientes, citas, estado de conversaciones, logs de mensajes, sesiones QR (cifradas), tokens OAuth2 de Google Calendar.</p></div>
  </div>
  <div class="stack-item">
    <span class="stack-badge alt">Queue</span>
    <div><strong>Bull + Redis</strong>
    <p>Cola de mensajes para el scheduling de recordatorios y reseÃ±as. Reintentos automÃ¡ticos con backoff exponencial. Rate limiting por clÃ­nica para no superar lÃ­mites de WhatsApp.</p></div>
  </div>
  <div class="stack-item">
    <span class="stack-badge alt">WhatsApp Meta</span>
    <div><strong>360dialog (recomendado) o Twilio WhatsApp</strong>
    <p>BSP (Business Solution Provider) para Meta Cloud API. 360dialog: ~15â‚¬/mes/nÃºmero, mejor soporte en Europa, panel de gestiÃ³n de plantillas. Twilio: mayor coste pero mÃ¡s documentaciÃ³n.</p></div>
  </div>
  <div class="stack-item">
    <span class="stack-badge alt">WhatsApp QR</span>
    <div><strong>LibrerÃ­a de conexiÃ³n multidispositivo (Node.js)</strong>
    <p>GestiÃ³n de sesiones multidispositivo de WhatsApp Web. Credenciales de sesiÃ³n cifradas con AES-256 y almacenadas en PostgreSQL para persistencia entre reinicios.</p></div>
  </div>
  <div class="stack-item">
    <span class="stack-badge">IA</span>
    <div><strong>OpenAI GPT-4o-mini</strong>
    <p>FAQ automÃ¡tico con contexto de la clÃ­nica (horario, direcciÃ³n, servicios). DetecciÃ³n de intenciÃ³n en mensajes libres. Prompt configurable por clÃ­nica desde el panel.</p></div>
  </div>
  <div class="stack-item">
    <span class="stack-badge warn">Hosting</span>
    <div><strong>Railway</strong> (infraestructura ya disponible en Ainertia)
    <p>Node.js + PostgreSQL + Redis en el mismo proyecto. Auto-deploy desde GitHub. Suficiente para MVP y primeros 100 clientes.</p></div>
  </div>
  <div class="stack-item">
    <span class="stack-badge warn">Frontend</span>
    <div><strong>React + Vite (o Next.js)</strong>
    <p>Panel de control por clÃ­nica. AutenticaciÃ³n JWT. Rutas: dashboard, citas, mensajes, configuraciÃ³n de WhatsApp (QR o Meta), integraciÃ³n de agenda.</p></div>
  </div>

  <h3>Variables de entorno</h3>
  <pre>
# Base de datos y queue
DATABASE_URL=postgresql://user:pass@host:5432/dental_auto
REDIS_URL=redis://localhost:6379

# App
NODE_ENV=production
PORT=3000
JWT_SECRET=secret_muy_largo_min_32chars
ADMIN_SECRET=clave_acceso_superadmin
SESSION_ENCRYPTION_KEY=clave_aes256_para_sesiones_qr

# WhatsApp Meta (360dialog) â€” si alguna clÃ­nica usa este modo
# Cada clÃ­nica tiene su propia API key guardada en DB (tabla clinicas.wa_api_key)
# No hay variables globales de WhatsApp Meta

# Google Calendar OAuth2
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GOOGLE_REDIRECT_URI=https://api.ainertia.ai/auth/google/callback

# OpenAI (FAQ automÃ¡tico)
OPENAI_API_KEY=...
OPENAI_MODEL=gpt-4o-mini

# Email (notificaciones internas a recepciÃ³n)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=notificaciones@ainertia.ai
SMTP_PASS=app_password
  </pre>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECCIÃ“N 6 â€” SCHEMA DE BASE DE DATOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page">
  <div class="section-label">SecciÃ³n 6</div>
  <h2>Schema de base de datos</h2>

  <pre>
-- â”€â”€ CLINICAS (un registro por cliente) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CREATE TABLE clinicas (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nombre           VARCHAR(200) NOT NULL,
  plan             VARCHAR(20) DEFAULT 'basico',  -- basico | profesional | avanzado
  activo           BOOLEAN DEFAULT true,

  -- WhatsApp â€” modo de conexiÃ³n
  wa_provider      VARCHAR(10) DEFAULT 'qr',      -- 'qr' | 'meta'
  wa_telefono      VARCHAR(20) UNIQUE,             -- nÃºmero que usan (normalizado E.164)
  wa_phone_id      VARCHAR(50),                    -- Solo Meta: phone_number_id (360dialog)
  wa_api_key       TEXT,                           -- Solo Meta: API key cifrada

  -- IntegraciÃ³n agenda
  agenda_method    VARCHAR(20) DEFAULT 'csv',     -- csv | webhook | google_calendar | software
  google_tokens    TEXT,                           -- access+refresh token (AES-256 cifrado)

  -- ConfiguraciÃ³n mensajes
  config           JSONB DEFAULT '{}',             -- mensajes custom, horarios, link Google Maps...
  google_maps_url  TEXT,
  created_at       TIMESTAMPTZ DEFAULT NOW()
);

-- â”€â”€ SESIONES QR (persistencia de conexiÃ³n) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CREATE TABLE wa_sessions (
  clinica_id    UUID PRIMARY KEY REFERENCES clinicas(id) ON DELETE CASCADE,
  creds_json    TEXT NOT NULL,        -- sesiÃ³n multidispositivo cifrada AES-256
  connected     BOOLEAN DEFAULT false,
  last_seen     TIMESTAMPTZ,
  updated_at    TIMESTAMPTZ DEFAULT NOW()
);

-- â”€â”€ PACIENTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CREATE TABLE pacientes (
  id             UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinica_id     UUID REFERENCES clinicas(id) ON DELETE CASCADE,
  nombre         VARCHAR(100) NOT NULL,
  telefono_norm  VARCHAR(20) NOT NULL,   -- E.164: +34612345678
  email          VARCHAR(200),
  activo         BOOLEAN DEFAULT true,
  opt_out        BOOLEAN DEFAULT false,  -- paciente solicitÃ³ STOP
  created_at     TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(clinica_id, telefono_norm)
);

-- â”€â”€ CITAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CREATE TABLE citas (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinica_id            UUID REFERENCES clinicas(id) ON DELETE CASCADE,
  paciente_id           UUID REFERENCES pacientes(id),
  fecha_hora            TIMESTAMPTZ NOT NULL,
  duracion_min          INTEGER DEFAULT 45,
  tipo                  VARCHAR(100),
  dentista              VARCHAR(100),
  estado                VARCHAR(20) DEFAULT 'pendiente',
    -- pendiente | confirmada | cancelada | completada | no_respondio
  ext_id                VARCHAR(100),   -- ID en sistema origen (deduplicaciÃ³n)
  recordatorio_enviado  BOOLEAN DEFAULT false,
  recordatorio_ts       TIMESTAMPTZ,
  resena_solicitada     BOOLEAN DEFAULT false,
  resena_ts             TIMESTAMPTZ,
  created_at            TIMESTAMPTZ DEFAULT NOW()
);

-- â”€â”€ CONVERSACIONES ACTIVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CREATE TABLE conversaciones (
  id             UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinica_id     UUID REFERENCES clinicas(id),
  paciente_id    UUID REFERENCES pacientes(id),
  telefono       VARCHAR(20) NOT NULL,
  estado         VARCHAR(30) DEFAULT 'idle',
    -- idle | esperando_confirmacion | en_cancelacion | en_reagendado | en_faq
  contexto       JSONB DEFAULT '{}',   -- cita_id, paso del flujo, historial IA...
  ultimo_msg     TIMESTAMPTZ,
  created_at     TIMESTAMPTZ DEFAULT NOW()
);

-- â”€â”€ LOG DE MENSAJES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CREATE TABLE mensajes_log (
  id             UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinica_id     UUID REFERENCES clinicas(id),
  paciente_id    UUID REFERENCES pacientes(id),
  direccion      VARCHAR(10) NOT NULL,   -- entrante | saliente
  contenido      TEXT,
  tipo           VARCHAR(30),
    -- recordatorio | confirmacion | cancelacion | resena | faq | sistema
  wa_msg_id      VARCHAR(100),
  created_at     TIMESTAMPTZ DEFAULT NOW()
);

-- â”€â”€ ÃNDICES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CREATE INDEX idx_citas_clinica_fecha  ON citas(clinica_id, fecha_hora);
CREATE INDEX idx_citas_recordatorio   ON citas(recordatorio_enviado, fecha_hora) WHERE estado = 'pendiente';
CREATE INDEX idx_citas_resena         ON citas(resena_solicitada, fecha_hora)    WHERE estado = 'completada';
CREATE INDEX idx_pacientes_telefono   ON pacientes(clinica_id, telefono_norm);
CREATE INDEX idx_conv_telefono        ON conversaciones(clinica_id, telefono);
CREATE INDEX idx_mensajes_clinica_ts  ON mensajes_log(clinica_id, created_at DESC);
  </pre>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECCIÃ“N 7 â€” FLUJOS DE AUTOMATIZACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page">
  <div class="section-label">SecciÃ³n 7</div>
  <h2>Flujos de automatizaciÃ³n (Node.js nativo)</h2>

  <p>Todos los flujos estÃ¡n implementados en Node.js. El <strong>Scheduler Engine</strong> usa <code>node-cron</code> para disparar jobs y <strong>Bull</strong> para ejecutarlos en cola con reintentos.</p>

  <h3>Flujo 1 â€” Recordatorio y confirmaciÃ³n de cita</h3>
  <div class="flow">
<span class="step">TRIGGER:</span> node-cron â€” cada 5 minutos
  â””â”€â”€ SELECT citas WHERE fecha_hora BETWEEN NOW()+23h AND NOW()+25h
      AND recordatorio_enviado = false AND estado = 'pendiente'

<span class="action">Para cada cita encontrada â†’ aÃ±adir job a Bull queue:</span>

  async function sendReminder(cita) {
    const clinica   = await getClinida(cita.clinica_id);
    const paciente  = await getPaciente(cita.paciente_id);
    const adapter   = createAdapter(clinica, sessionStore);
    const msg       = buildReminderMsg(clinica.config, cita, paciente);

    await adapter.sendMessage(paciente.telefono_norm, msg);
    // Meta: usa sendTemplate() con plantilla dental_reminder_es
    // QR:  usa sendMessage() con texto libre

    await db.query('UPDATE citas SET recordatorio_enviado=true, recordatorio_ts=NOW() WHERE id=$1', [cita.id]);
    await upsertConversacion(cita.clinica_id, paciente, 'esperando_confirmacion', { cita_id: cita.id });
  }

<span class="cond">RESPUESTA DEL PACIENTE (webhook entrante):</span>
  â”œâ”€â”€ Texto contiene: "sÃ­" / "si" / "confirmo" / "1"
  â”‚     â†’ cita.estado = 'confirmada'
  â”‚     â†’ enviar: "Â¡Perfecto! Te esperamos el {dia} a las {hora} ğŸ˜Š"
  â”‚     â†’ conversacion.estado = 'idle'
  â”œâ”€â”€ Texto contiene: "no" / "cancelo" / "cancelar"
  â”‚     â†’ cita.estado = 'cancelada'
  â”‚     â†’ Flujo 2 (notificaciÃ³n cancelaciÃ³n)
  â”œâ”€â”€ Texto contiene: "cambiar" / "reagendar" / "otro dÃ­a"
  â”‚     â†’ conversacion.estado = 'en_reagendado'
  â”‚     â†’ Flujo 3 (reagendado)
  â””â”€â”€ Sin respuesta en 4 horas
        â†’ Un segundo recordatorio (mÃ¡x. 1 reintento)
        â†’ Si tampoco responde: cita.estado = 'no_respondio'
  </div>

  <h3>Flujo 2 â€” CancelaciÃ³n y notificaciÃ³n a recepciÃ³n</h3>
  <div class="flow">
<span class="step">TRIGGER:</span> Paciente cancela (botÃ³n interactivo o mensaje de texto)

<span class="action">PASO 1:</span> cita.estado = 'cancelada'
<span class="action">PASO 2:</span> Mensaje al <u>paciente</u>:
  "Entendido, hemos cancelado tu cita del {dia} a las {hora}.
   Si quieres pedir una nueva hora, escrÃ­benos aquÃ­ ğŸ“…"
<span class="action">PASO 3:</span> NotificaciÃ³n a <u>recepciÃ³n de la clÃ­nica</u>:
  Modo 1 (WhatsApp) â†’ mensaje al nÃºmero de recepciÃ³n configurado:
    "âš ï¸ CANCELACIÃ“N: {paciente} ha cancelado su cita del {dia} {hora}"
  Modo 2 (Email) â†’ envÃ­o SMTP a la direcciÃ³n de la clÃ­nica
  Modo 3 (Panel) â†’ notificaciÃ³n push en el dashboard en tiempo real
<span class="action">PASO 4:</span> conversacion.estado = 'idle'
  </div>

  <h3>Flujo 3 â€” Solicitud de reseÃ±a Google</h3>
  <div class="flow">
<span class="step">TRIGGER:</span> node-cron â€” cada hora
  â””â”€â”€ SELECT citas WHERE estado = 'completada'
      AND fecha_hora BETWEEN NOW()-4h AND NOW()-2h
      AND resena_solicitada = false

<span class="action">Para cada cita â†’ job en Bull queue:</span>
  async function requestReview(cita) {
    const paciente = await getPaciente(cita.paciente_id);
    const clinica  = await getClinica(cita.clinica_id);
    const adapter  = createAdapter(clinica, sessionStore);

    await adapter.sendMessage(paciente.telefono_norm,
      `${paciente.nombre}, esperamos que hayas quedado satisfecho/a ğŸ˜Š\n` +
      `Si tienes un momento, nos ayudarÃ­a mucho que dejaras una reseÃ±a en Google:\n` +
      `${clinica.google_maps_url}`
    );

    await db.query('UPDATE citas SET resena_solicitada=true, resena_ts=NOW() WHERE id=$1', [cita.id]);
  }
  </div>

  <h3>Flujo 4 â€” FAQ con IA (planes Profesional y Avanzado)</h3>
  <div class="flow">
<span class="step">TRIGGER:</span> Webhook â€” mensaje entrante sin conversaciÃ³n activa

<span class="action">DetecciÃ³n de intenciÃ³n:</span>

  async function handleIncomingMessage(clinica, telefono, texto) {
    const conv = await getConversacion(clinica.id, telefono);

    // Si hay conversaciÃ³n activa, enrutar al flujo correspondiente
    if (conv && conv.estado !== 'idle') return handleActiveFlow(conv, texto);

    // Si es plan BÃ¡sico: respuesta genÃ©rica fija
    if (clinica.plan === 'basico') {
      return adapter.sendMessage(telefono, clinica.config.default_reply);
    }

    // Planes Profesional/Avanzado: FAQ con GPT-4o-mini
    const systemPrompt = buildClinicaPrompt(clinica); // horario, direcciÃ³n, servicios, precios orientativos
    const response = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: texto }
      ],
      max_tokens: 300
    });
    return adapter.sendMessage(telefono, response.choices[0].message.content);
  }

<span class="cond">Reglas de seguridad del prompt IA:</span>
  - "No menciones precios exactos sin antes confirmar con la clÃ­nica"
  - "Si no sabes la respuesta, indica que llamen al {telefono}"
  - "Nunca respondas con informaciÃ³n mÃ©dica especÃ­fica"
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECCIÃ“N 8 â€” API INTERNA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page">
  <div class="section-label">SecciÃ³n 8</div>
  <h2>Endpoints de la API</h2>

  <table>
    <thead><tr><th>MÃ©todo</th><th>Endpoint</th><th>DescripciÃ³n</th><th>Auth</th></tr></thead>
    <tbody>
      <tr><td><span class="badge badge-green">POST</span></td><td><code>/api/v1/auth/login</code></td><td>Login de admin de clÃ­nica â†’ JWT</td><td>â€”</td></tr>
      <tr><td><span class="badge badge-blue">GET</span></td><td><code>/api/v1/clinicas/:id/stats</code></td><td>MÃ©tricas: confirmaciones, ausencias, reseÃ±as</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-blue">GET</span></td><td><code>/api/v1/clinicas/:id/citas</code></td><td>Listado citas (filtros: fecha, estado)</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-blue">GET</span></td><td><code>/api/v1/clinicas/:id/mensajes</code></td><td>Log de mensajes enviados/recibidos</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-yellow">PATCH</span></td><td><code>/api/v1/clinicas/:id/config</code></td><td>Actualizar config (mensajes, horarios, prompt IA)</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-green">POST</span></td><td><code>/api/v1/clinicas/:id/agenda/import</code></td><td>Importar CSV de agenda</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-green">POST</span></td><td><code>/api/v1/webhooks/cita</code></td><td>Recibir cita desde agenda externa</td><td>API Key</td></tr>
      <tr><td><span class="badge badge-green">POST</span></td><td><code>/api/v1/whatsapp/webhook</code></td><td>Webhook Meta (mensajes entrantes)</td><td>HMAC-SHA256</td></tr>
      <tr><td><span class="badge badge-green">POST</span></td><td><code>/api/v1/clinicas/:id/whatsapp/qr</code></td><td>Iniciar sesiÃ³n QR (WS para stream del QR)</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-blue">GET</span></td><td><code>/api/v1/clinicas/:id/whatsapp/status</code></td><td>Estado de conexiÃ³n WhatsApp</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-blue">GET</span></td><td><code>/api/v1/auth/google</code></td><td>Iniciar OAuth2 Google Calendar</td><td>JWT</td></tr>
      <tr><td><span class="badge badge-blue">GET</span></td><td><code>/api/v1/auth/google/callback</code></td><td>Callback OAuth2 Google</td><td>â€”</td></tr>
      <tr><td><span class="badge badge-blue">GET</span></td><td><code>/api/v1/admin/clinicas</code></td><td>Listado todos los clientes (superadmin)</td><td>Admin Key</td></tr>
    </tbody>
  </table>

  <h3>WebSocket â€” Stream del QR</h3>
  <pre>
// El frontend se conecta al WS para recibir el QR en tiempo real
ws://api.ainertia.ai/ws/clinicas/:id/whatsapp-qr?token={jwt}

// Eventos del servidor â†’ cliente
{ "event": "qr",         "data": "data:image/png;base64,..." }  // QR listo
{ "event": "connected",  "data": { "telefono": "+34612345678" } } // SesiÃ³n OK
{ "event": "error",      "data": { "message": "..." } }

// El frontend muestra el QR en un <img> y escucha "connected" para redirigir al dashboard
  </pre>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECCIÃ“N 9 â€” SEGURIDAD Y RGPD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page">
  <div class="section-label">SecciÃ³n 9</div>
  <h2>Seguridad y cumplimiento RGPD</h2>

  <div class="grid-2">
    <div class="card">
      <h3>Medidas tÃ©cnicas</h3>
      <ul>
        <li>HTTPS obligatorio (TLS 1.3)</li>
        <li>Passwords con bcrypt (salt rounds: 12)</li>
        <li>JWT con expiraciÃ³n 8h + refresh token</li>
        <li>Sesiones QR cifradas con AES-256 en DB</li>
        <li>API Keys cifradas en DB (nunca en texto claro)</li>
        <li>Tokens Google Calendar cifrados (AES-256)</li>
        <li>Webhook Meta verificado con HMAC-SHA256</li>
        <li>Rate limiting: 100 req/min por clÃ­nica</li>
        <li>Aislamiento total por <code>clinica_id</code></li>
        <li>Logs sin PII en texto claro</li>
      </ul>
    </div>
    <div class="card">
      <h3>Obligaciones RGPD</h3>
      <ul>
        <li>DPA firmado con cada clÃ­nica antes del go-live</li>
        <li>Pacientes deben haber dado consentimiento explÃ­cito</li>
        <li>Mecanismo de baja (responder STOP) implementado</li>
        <li>Datos almacenados en servidores dentro de la UE</li>
        <li>RetenciÃ³n de logs: 90 dÃ­as (configurable)</li>
        <li>Derecho al olvido: <code>DELETE /api/v1/pacientes/:id</code></li>
        <li>Derecho de acceso: exportaciÃ³n CSV de datos del paciente</li>
      </ul>
    </div>
  </div>

  <div class="alert alert-warn">
    âš ï¸ <span><strong>Modo Meta â€” Templates obligatorios:</strong> fuera de la ventana de 24h de conversaciÃ³n activa, WhatsApp exige usar <em>Message Templates</em> aprobados por Meta para el primer mensaje (ej. recordatorio de cita). Las respuestas del paciente abren la ventana y permiten mensajes libres durante 24h.</span>
  </div>

  <h3>Template requerido (recordatorio de cita â€” Meta)</h3>
  <pre>
Nombre:    dental_reminder_es
Idioma:    es_ES
CategorÃ­a: UTILITY
Estado:    APPROVED (solicitar antes del go-live)

Cuerpo:
  "Hola {{1}} ğŸ‘‹ Te recordamos tu cita en {{2}} el {{3}} a las {{4}}
   con {{5}}. Â¿Confirmas tu asistencia?
   Responde SÃ para confirmar, NO para cancelar."

Variables:
  {{1}} nombre_paciente
  {{2}} nombre_clinica
  {{3}} dia_semana + fecha
  {{4}} hora
  {{5}} dentista

Nota: en modo QR este template se envÃ­a como texto libre (no requiere aprobaciÃ³n Meta).
  </pre>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECCIÃ“N 10 â€” ESTIMACIÃ“N DE DESARROLLO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page">
  <div class="section-label">SecciÃ³n 10</div>
  <h2>EstimaciÃ³n de desarrollo â€” MVP (plan BÃ¡sico + Profesional)</h2>

  <table>
    <thead><tr><th>MÃ³dulo</th><th>DescripciÃ³n</th><th>EstimaciÃ³n</th><th>Prioridad</th></tr></thead>
    <tbody>
      <tr><td><strong>Setup inicial</strong></td><td>Proyecto, DB, Railway, estructura multi-tenant</td><td>1 dÃ­a</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>Schema DB + migraciones</strong></td><td>Tablas, Ã­ndices, seed de prueba</td><td>0.5 dÃ­as</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>Auth multi-tenant</strong></td><td>Login, JWT, middleware aislamiento por clÃ­nica</td><td>1 dÃ­a</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>WhatsApp QRAdapter</strong></td><td>ConexiÃ³n QR, persistencia sesiÃ³n, WebSocket stream QR</td><td>2 dÃ­as</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>WhatsApp MetaAdapter</strong></td><td>360dialog API, webhook HMAC, templates</td><td>1.5 dÃ­as</td><td><span class="badge badge-yellow">Media</span></td></tr>
      <tr><td><strong>WhatsApp Factory + panel selecciÃ³n</strong></td><td>PatrÃ³n Adapter + UI de selecciÃ³n de proveedor</td><td>0.5 dÃ­as</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>IntegraciÃ³n CSV</strong></td><td>Import, normalizaciÃ³n telÃ©fonos, deduplicaciÃ³n</td><td>1 dÃ­a</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>IntegraciÃ³n Google Calendar</strong></td><td>OAuth2, sync bidireccional, mapeo configurable</td><td>2 dÃ­as</td><td><span class="badge badge-yellow">Media</span></td></tr>
      <tr><td><strong>Scheduler + Bull Queue</strong></td><td>Cron de recordatorios y reseÃ±as, reintentos</td><td>1 dÃ­a</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>Flujos de conversaciÃ³n</strong></td><td>MÃ¡quina de estados: confirmaciÃ³n, cancelaciÃ³n, FAQ</td><td>2 dÃ­as</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>AI FAQ Engine</strong></td><td>GPT-4o-mini con prompt por clÃ­nica</td><td>1 dÃ­a</td><td><span class="badge badge-yellow">Media</span></td></tr>
      <tr><td><strong>Panel de control</strong></td><td>Dashboard: mÃ©tricas, citas, config, estado WA</td><td>3 dÃ­as</td><td><span class="badge badge-yellow">Media</span></td></tr>
      <tr><td><strong>Templates Meta + aprobaciÃ³n</strong></td><td>Crear y enviar a Meta para revisiÃ³n</td><td>1-3 dÃ­as</td><td><span class="badge badge-red">Alta</span></td></tr>
      <tr><td><strong>Testing + QA piloto</strong></td><td>Pruebas con primera clÃ­nica real</td><td>2 dÃ­as</td><td><span class="badge badge-yellow">Media</span></td></tr>
    </tbody>
  </table>

  <div class="card" style="margin-top:1.25rem">
    <h3>â±ï¸ Total estimado MVP completo: 18-22 dÃ­as de desarrollo</h3>
    <p style="margin-top:.5rem;color:var(--muted);font-size:.875rem">Con un desarrollador senior full-stack. Cuello de botella: aprobaciÃ³n de templates por Meta (1-3 dÃ­as hÃ¡biles). El mÃ³dulo QR es independiente y puede ir a producciÃ³n sin esperar la aprobaciÃ³n Meta.</p>
  </div>

  <h3>Orden de desarrollo recomendado</h3>
  <ol>
    <li>Setup + DB + Auth multi-tenant</li>
    <li>WhatsApp QRAdapter (va a producciÃ³n primero, sin dependencias Meta)</li>
    <li>ImportaciÃ³n CSV de agenda</li>
    <li>Scheduler + flujo de recordatorio bÃ¡sico</li>
    <li>Flujos: confirmaciÃ³n, cancelaciÃ³n, reseÃ±a</li>
    <li>Panel de control bÃ¡sico (estado WA, listado citas, log mensajes)</li>
    <li>Prueba piloto con primera clÃ­nica (plan BÃ¡sico, modo QR)</li>
    <li>WhatsApp MetaAdapter + plantillas Meta</li>
    <li>Google Calendar OAuth2</li>
    <li>AI FAQ Engine</li>
    <li>Panel avanzado con mÃ©tricas</li>
  </ol>

  <div class="alert alert-info">
    â„¹ï¸ <span><strong>Estrategia de rollout:</strong> lanzar primero con el modo QR (sin trÃ¡mites Meta), captar las primeras clÃ­nicas piloto y refinir el producto. Activar el modo nÃºmero verificado Meta como upgrade una vez validado el negocio.</span>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECCIÃ“N 11 â€” CHECKLIST GO-LIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page">
  <div class="section-label">SecciÃ³n 11</div>
  <h2>Checklist antes de lanzar con primer cliente</h2>

  <div class="grid-2">
    <div class="card">
      <h3>Infraestructura</h3>
      <ul>
        <li>â˜ PostgreSQL en producciÃ³n con backups diarios</li>
        <li>â˜ Redis configurado y persistente</li>
        <li>â˜ Variables de entorno en Railway (nunca en cÃ³digo)</li>
        <li>â˜ Dominio propio con SSL (<code>api.ainertia.ai</code>)</li>
        <li>â˜ MonitorizaciÃ³n activa (UptimeRobot o similar)</li>
        <li>â˜ Alertas de error por email/Slack</li>
      </ul>
    </div>
    <div class="card">
      <h3>WhatsApp (modo QR)</h3>
      <ul>
        <li>â˜ QR generado y visible en el panel de la clÃ­nica</li>
        <li>â˜ SesiÃ³n escaneada y persistida en DB</li>
        <li>â˜ Test de envÃ­o y recepciÃ³n confirmado</li>
        <li>â˜ ReconexiÃ³n automÃ¡tica tras reinicio probada</li>
        <li>â˜ Alerta de desconexiÃ³n configurada para la clÃ­nica</li>
      </ul>
    </div>
    <div class="card">
      <h3>WhatsApp (modo Meta)</h3>
      <ul>
        <li>â˜ Cuenta Meta Business verificada</li>
        <li>â˜ NÃºmero aprobado en 360dialog</li>
        <li>â˜ Template <code>dental_reminder_es</code> aprobado por Meta</li>
        <li>â˜ Webhook 360dialog configurado y verificado</li>
        <li>â˜ Test de envÃ­o con nÃºmero de prueba</li>
      </ul>
    </div>
    <div class="card">
      <h3>ClÃ­nica piloto</h3>
      <ul>
        <li>â˜ Formato de exportaciÃ³n de agenda acordado</li>
        <li>â˜ Mensajes personalizados con nombre de clÃ­nica</li>
        <li>â˜ URL de Google Maps configurada para reseÃ±as</li>
        <li>â˜ NotificaciÃ³n de cancelaciones: WhatsApp o email</li>
        <li>â˜ DPA firmado (RGPD)</li>
        <li>â˜ Prueba completa del ciclo con paciente real</li>
      </ul>
    </div>
  </div>
</div>

<!-- FOOTER -->
<div class="doc-footer">
  <span>Ainertia Capital S.L. Â· CIF B75739656 Â· CÃ³rdoba, EspaÃ±a</span>
  <span>Documento tÃ©cnico confidencial Â· v2.0 Â· Febrero 2026</span>
</div>

</body>
</html>
